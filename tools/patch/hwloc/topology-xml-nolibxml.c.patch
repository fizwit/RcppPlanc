Subject: [PATCH] topology-xml-nolibxml.c.patch
---
Index: hwloc/topology-xml-nolibxml.c
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/hwloc/topology-xml-nolibxml.c b/hwloc/topology-xml-nolibxml.c
--- a/hwloc/topology-xml-nolibxml.c	(revision f262ce42ff5a007a8f247b546a6fc322b2922d1e)
+++ b/hwloc/topology-xml-nolibxml.c	(date 1699467927529)
@@ -15,7 +15,7 @@
 #include "private/debug.h"
 
 #include <string.h>
-#include <assert.h>
+//#include <assert.h>
 #include <sys/types.h>
 #include <sys/stat.h>
 #ifdef HAVE_UNISTD_H
@@ -326,9 +326,9 @@
 {
   hwloc_nolibxml_free_buffers(bdata);
 
-  if (result < 0 && hwloc__xml_verbose())
-    fprintf(stderr, "Failed to parse XML input with the minimalistic parser. If it was not\n"
-	    "generated by hwloc, try enabling full XML support with libxml2.\n");
+  // if (result < 0 && hwloc__xml_verbose())
+    // fprintf(stderr, "Failed to parse XML input with the minimalistic parser. If it was not\n"
+	//    "generated by hwloc, try enabling full XML support with libxml2.\n");
 }
 
 /********************
@@ -594,7 +594,7 @@
   hwloc__nolibxml_export_state_data_t ndata = (void *) state->data;
   int res;
 
-  assert(!npdata->has_content);
+  //assert(!npdata->has_content);
   if (!npdata->nr_children) {
     res = hwloc_snprintf(npdata->buffer, npdata->remaining, ">\n");
     hwloc__nolibxml_export_update_buffer(npdata, res);
@@ -637,7 +637,7 @@
   hwloc__nolibxml_export_state_data_t npdata = (void *) state->parent->data;
   int res;
 
-  assert (!(ndata->has_content && ndata->nr_children));
+  //assert (!(ndata->has_content && ndata->nr_children));
   if (ndata->has_content) {
     res = hwloc_snprintf(ndata->buffer, ndata->remaining, "</%s>\n", name);
   } else if (ndata->nr_children) {
@@ -658,7 +658,7 @@
   hwloc__nolibxml_export_state_data_t ndata = (void *) state->data;
   int res;
 
-  assert(!ndata->nr_children);
+  //assert(!ndata->nr_children);
   if (!ndata->has_content) {
     res = hwloc_snprintf(ndata->buffer, ndata->remaining, ">");
     hwloc__nolibxml_export_update_buffer(ndata, res);
@@ -749,7 +749,8 @@
     return -1;
 
   if (!strcmp(filename, "-")) {
-    file = stdout;
+      free(buffer);
+      return -1;
   } else {
     file = fopen(filename, "w");
     if (!file) {
@@ -768,8 +769,8 @@
 
   free(buffer);
 
-  if (file != stdout)
-    fclose(file);
+
+  fclose(file);
   return ret;
 }
 
@@ -849,7 +850,8 @@
     return -1;
 
   if (!strcmp(filename, "-")) {
-    file = stdout;
+      free(buffer);
+      return -1;
   } else {
     file = fopen(filename, "w");
     if (!file) {
@@ -868,8 +870,8 @@
 
   free(buffer);
 
-  if (file != stdout)
-    fclose(file);
+
+  fclose(file);
   return ret;
 }
 
